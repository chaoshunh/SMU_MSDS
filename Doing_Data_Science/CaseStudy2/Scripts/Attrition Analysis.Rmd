---
title: 'Analysis of Attrition Data: Main factors that affect Employee Turnover'
author: "Chaoshun Hu, Mahesh Kuklani, Rene Pineda"
date: "August 7, 2018"
output:
  html_document:
    keep_md: yes
  pdf_document: default
---

```{r Loading packages and data, echo = FALSE, message=FALSE, warning=FALSE}
#Install Packages
library(dataMaid) #For quick data visualization
library(dplyr) #For data cleaning and summarizing
library(ggplot2) #For histograms and other plots
library(scales) # For formatting in data labels
library(qwraps2) #For tables and document markdown

#Load the data

talentManage <- read.delim('E:/Bibliotecas/Documents/Data Science/SMU/MSDS 6306 Doing Data Science/Case Study 2/SMU_MSDS/Doing_Data_Science/CaseStudy2/data/casestudy2.csv', header = TRUE, sep = ',')
#talentManage <-read.csv("C:\\Users\\chux\\datascience\\MSDS6306CaseStudy2\\data\\casestudy2.csv")
```

## Introduction

Voluntary attrition occurs when an employee leaves a company of his or her own accord. This can occur when employees leave their current positions for another job, leave the workforce entirely, or retire. The reasons for leaving a company can vary from personal reasons, such as desiring career advancement or moving to a different city, to company-based reasons, such as an unwanted change in company structure or management.

A high turnover rate typically means working conditions are not optimal, pay is below market average, or staffers are not well trained. Concurrently, a low turnover rate is indicative of a work environment where staffers feel appreciated, work as a team, have room to move up the corporate ladder, and are satisfied with their jobs.

Attrition rates vary widely accross industries. The following tables show attrition rates in the United States:

![](E:/Bibliotecas/Documents/Data Science/SMU/MSDS 6306 Doing Data Science/Project 2/Attrition Statistics.jpg) 

Employee attrition statistics have worsened in recent years, after years of recovery over the recesion of 2008:

![](E:/Bibliotecas/Documents/Data Science/SMU/MSDS 6306 Doing Data Science/Project 2/Historical Attrition.jpg) 

Source: CompData's 2016 edition of their annual BenchmarkPro Survey

Companies usually would like to decrease their voluntary turnover rates due to numerous unfavorable impacts:

* Overall poor company performance

* Low employee morale

* Operating and monetary costs (severance payments, cost of re-hiring and re-training)

* Money invested in the employees that leave the company can't be recovered

* The decrease in the workforce causes remaining employees to work on the slack left behind- mostly performing the task they are not completely trained to perform or are not the best suited

* The situation may get out of control and lead to mass exit of employees, disabling the ability of the company to perform at a high level.

In order to deal with employee attrition and deal with its negative impacts, it is important to know about the most important causes of Attrition. The purpose of this analysis is to try to dilucidate what are the most important factors that contribute to attrition, amongst the many factors that affect an employee's environment and satisfaction. Once these factors are determined, a company can take actions to control them. 


### 2.	Loading and cleaning the data 

**a	Read the csv into R and take a look at the data set.  Output how many rows and columns the data.frame is.**
```{r Question 2a, echo=TRUE, warning=FALSE, message=FALSE}
dim(talentManage)
```
The `talentManage` data frame has 1470 rows and 35 columns. 

**b	The column names are either too much or not enough.  Change the column names so that they do not have spaces, underscores, slashes, and the like. All column names should be under 12 characters. Make sure you’re updating your codebook with information on the tidied data set as well.**

We use an R function to automatically abbreviate the variable names:
```{r Question 2b, echo=TRUE, warning=FALSE, message=FALSE}
#List column names
colnames(talentManage)

#Abbreviate column names
colnames(talentManage)=abbreviate(colnames(talentManage), method=c("both.sides"),minlength = 11)
```

We will now list the column names again and count the characters to confirm confirm that none exceeds the 12-character limit
```{r echo=TRUE, warning=FALSE, message=FALSE}
columns <- colnames(talentManage)
columns
sapply(columns, nchar)
```

**c.	Some columns are, due to Qualtrics, malfunctioning. **

**d.	Make sure your columns are the proper data types (i.e., numeric, character, etc.).  If they are incorrect, convert them.**

```{r Question 2c, echo=TRUE, warning=FALSE, message=FALSE}
#Check the 'class' of each variable column
lapply(talentManage, class)

#Recode variables from 'numeric' to 'factor'
talentManage[,7] <- factor(talentManage[,7], labels = c("Below College", "College", "Bachelor", "Master", "Doctor"), ordered = TRUE)
talentManage[,11] <- factor(talentManage[,11], labels = c('Low', 'Medium', 'High', 'Very High'), ordered = TRUE)
talentManage[,14] <- factor(talentManage[,14], labels = c('Low', 'Medium', 'High', 'Very High'), ordered = TRUE)
talentManage[,17] <- factor(talentManage[,17], labels = c('Low', 'Medium', 'High', 'Very High'), ordered = TRUE)
talentManage[,25] <- factor(talentManage[,25], labels = c('Excellent', 'Outstanding'), ordered = TRUE)
talentManage[,26] <- factor(talentManage[,26], labels = c('Low', 'Medium', 'High', 'Very High'), ordered = TRUE)
talentManage[,31] <- factor(talentManage[,31], labels = c('Bad', 'Good', 'Better', 'Best'), ordered = TRUE)
talentManage[,15] <- factor(talentManage[,15], ordered = TRUE)
talentManage[,28] <- factor(talentManage[,28])

#Perform an additional recoding: divide the "Years with Current Manager" variable into three groups
talentManage[,35] <- cut(talentManage[,35], breaks = c(0,5,10,17), labels = c("0-5", "6-10", "More than 10"), right = TRUE, include.lowest = TRUE, ordered_result = TRUE)

#Check that all variables have the correct 'class'
str(talentManage)
```

### 3.	Preliminary Analysis

**a	Remove all observations where the participant is under age 18.  No further analysis of underage individuals is permitted by your client.  Remove any other age outliers as you see fit, but be sure to tell what you’re doing and why.**

First we apply a function to check whether there are participants under age 18:
```{r Question 3a, echo=TRUE, warning=FALSE, message=FALSE}
#Check every value of the 'Age' variable to see whether it is smaller than 18
summary(sapply(talentManage$Age, function(x) x < 18))
```
There are no participants under age 18.

Regarding outliers, we might want to remove participants who have passed the age of retirement (65 years old, although this has increased due to SS ammendments) and that might be having a negative impact in attrition rates, because attrition would be disproportionately high in this group. We can check this in the data
```{r Question 3aout, echo=TRUE, warning=FALSE, message=FALSE}
#Check every value of the 'Age' variable to see whether it is smaller than 18
summary(sapply(talentManage$Age, function(x) x >= 65))
retirement <- subset(talentManage$Age, talentManage$Age >=60)
retirement  
```
We do not have instances of people 65 years old or older, and only a handful of participants are 60 years old. We proceed without eliminating any data points. 

**b	Please provide (in table format or similar), descriptive statistics on at least 7 variables (age, Income, etc.).  Create a simple histogram for two of them.  Comment on the shape of the distribution in your markdown.**
```{r Question 3b, echo=TRUE, warning=FALSE, message=FALSE, results='asis'}
options(qwraps2_markup = "markdown")
summary_numeric <- with(talentManage,
                list("Age" = tab_summary(Age)[c(1,4,2,3)],
                     "Monthly Income" = tab_summary(MonthlyIncm)[c(1,4,2,3)],
                     "Distance From Home" = tab_summary(DistncFrmHm)[c(1,4,2,3)],
                     "Number of Companies Worked In" = tab_summary(NmCmpnsWrkd)[c(1,4,2,3)],
                     "Percent Salary Raise" = tab_summary(PrcntSlryHk)[c(1,4,2,3)],
                     "Total working Years" = tab_summary(TtlWrkngYrs)[c(1,4,2,3)],
                     "Years at Company" = tab_summary(YersAtCmpny)[c(1,4,2,3)]))
                     
table_numeric <- summary_table(talentManage, summary_numeric)
table_numeric
```

We want to see the histogram of the `Age` variable:
```{r histogram Age, echo=FALSE}
#Create the required histograms
ggplot(data = talentManage, mapping = aes(Age)) +
  geom_histogram(binwidth = 5, color = "gray", fill = "royalblue1" ) +
  labs(x = "Age", y = "Frequency", title = "Histogram of Age") + 
  theme(plot.title = element_text(hjust = 0.5))
```

The shape of te histogram resembles a normal distribuiton, with a slight positive bias (mean > median)

And now the histogram of the `Income` variable:
```{r histogram income, echo=TRUE}
ggplot(data = talentManage, mapping = aes(MonthlyIncm)) +
  geom_histogram(binwidth = 1000, color = "gray", fill = "orchid3" ) +
  labs(x = "Montly income (in US$)", y = "Frequency", title = "Histogram of Monthly Income") + 
  scale_x_continuous(label = comma) +
  theme(plot.title = element_text(hjust = 0.5)) 
```

The histogram shows a strong positive skewness, which is typical of Income distributions: a small group of people in the organization have very high salaries. 

**c	Give the frequencies (in table format or similar) for Gender, Education, and Occupation.  They can be separate tables, if that’s your choice.**
```{r Question 3c, echo=TRUE, warning=FALSE, message=FALSE, results='asis'}
# Summarize categorical variables with counts

summary_factor <- with(talentManage,
                list("Gender" = tab_summary(factor(Gender)),
                     "Education" = tab_summary(factor(Education)),
                     "Ocupation" = tab_summary(factor(EducatinFld))))

table_factor <- summary_table(talentManage, summary_factor)
table_factor
```

**d	Give the counts (again, table) of management positions.**
```{r Question 3d, echo=TRUE, warning=FALSE, message=FALSE, results='asis'}
summary_positions <- with(talentManage,
                     list("Management Positions" = tab_summary(factor(JobLevel[JobLevel == 3 | JobLevel ==4 | JobLevel ==5]))))

table_positions <- summary_table(talentManage, summary_positions)
table_positions
```

### Additional Analysis

Examine the proportion of attrition vs. No Attrition

```{r echo = TRUE}
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = Attrition, fill = Attrition)) +
  annotate("text", label = "Yes = 233, or 15.9%", y=350, x=2) +
  annotate("text", label = "No = 1237, or 84.1%", y=1300, x=1) +
  labs(x = "Attrition", y = "Total", title = "Summary of Attrition") +
  theme(plot.title = element_text(hjust = 0.5)) +
  guides(fill=FALSE)
```

Investigate whether there are differences in attrition by continuous and categorical variables (Age and Gender, Marital Status and distance from home, Income and Job Level)
```{r echo = TRUE}
#Graphing Age and Gender
ggplot((talentManage), aes(Age, as.numeric(Attrition)-1, color=Gender)) +
  stat_smooth(method="loess", formula=y~x, alpha=0.2, size=2, aes(fill=Gender)) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  labs(title = "Attrition levels by age and gender", x= "Age", y = "Proportion of Attrition")

# Using distance from home and Marital Status:
ggplot((talentManage), aes(DistncFrmHm, as.numeric(Attrition)-1, color=MaritalStts)) +
  stat_smooth(method="loess", formula=y~x,
              alpha=0.2, size=2, aes(fill=MaritalStts)) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Distance from Home") + ylab("Attrition")

# Using Montly Income and Job Level:
ggplot((talentManage), aes(MonthlyIncm, as.numeric(Attrition)-1, color=JobLevel)) +
  stat_smooth(method="loess", formula=y~x,
              alpha=0.2, size=2, aes(fill=JobLevel)) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Monthly Income in US$") + ylab("Attrition")

# Using Years in the Company
ggplot((talentManage), aes(YersAtCmpny, as.numeric(Attrition)-1, color=StckOptnLvl)) +
  stat_smooth(method="loess", formula=y~x,
              alpha=0.2, size=2, aes(fill=StckOptnLvl)) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Years Worked at the Company") + ylab("Attrition")
```

Analyze if the proportion of Attrition vs. No Attrition varies significantly among different categorical variables, related to Job Satisfaction and organizational factors

```{r Additional bar graphs, echo=TRUE, results='asis'}
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = JobSatsfctn, fill = Attrition), position = "fill") +
  labs(x = "Job Satisfaction (4 is higher)", y = "Proportion", title = "Attrition by Level of Job Satisfaction")
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = JobInvlvmnt, fill = Attrition), position = "fill") +
  labs(x = "Job Involvement (4 is higher)", y = "Proportion", title = "Attrition by Level of Job Involvement")
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = Department, fill = Attrition), position = "fill") +
  labs(x = "Department", y = "Proportion", title = "Attrition by Department")
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = YrsWthCrrMn, fill = Attrition), position = "fill") +
  labs(x = "Years with Current Manager", y = "Proportion", title = "Attrition levels by Years with Current Manager")
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = RltnshpStsf, fill = Attrition), position = "fill") +
  labs(x = "Relationship Satisfaction", y = "Proportion", title = "Attrition by Relationship Satisfaction")
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = BusinssTrvl, fill = Attrition), position = "fill") +
  labs(x = "Business Travel", y = "Proportion", title = "Attrition for Business Travel")
```

Do people with a history of changing jobs have a larger tendency for Attrition (controlling by Environment Satisfaction)?
```{r Number of jobs, echo = TRUE}
ggplot((talentManage), aes(NmCmpnsWrkd, as.numeric(Attrition)-1, color=EnvrnmntSts)) +
  stat_smooth(method="loess", formula=y~x,
              alpha=0.2, size=2, aes(fill=EnvrnmntSts)) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Number of previous Jobs") + ylab("Attrition")
```


We see very clear differences in Attrition by Job Role:
```{r Job Role chart, echo=TRUE}
ggplot(data = talentManage) + 
  geom_bar(mapping = aes(x = JobRole, fill = Attrition), position = "fill") +
  labs(x = "Job Role", y = "Proportion", title = "Attrition by Job Roles") +
  coord_flip()
```

Create the new variable `AggSatisfaction` that aggregates closely related variables: `Job Satisfaction`, `Job Involvement`, `Environment Satisfaction` and `Relationship Satisfaction`.

```{r aggregate job satisfaction, echo=TRUE, message=FALSE, warning=FALSE}
talentManage$AggStsfctn = (as.numeric(talentManage$EnvrnmntSts) + as.numeric(talentManage$JobInvlvmnt) + as.numeric(talentManage$JobSatsfctn) + as.numeric(talentManage$RltnshpStsf)) /4
```

Explore satisfaction levels by Job Role:

```{r Job Role boxplot, echo=TRUE}
ggplot(data = talentManage, aes(x=JobRole, y = AggStsfctn, color=JobRole)) + 
  geom_boxplot() +
  labs(x = "Job Role", y = "Aggregate Satisfaction", title = "Aggregate Satisfaction by Job Role") +
  coord_flip() +
  guides(colour=FALSE)
```

### 4.	Deeper Analysis and Visualization 

a	Note: You should make all of these appealing looking.  Remember to include things like a clean, informative title, axis labels that are in plain English, and readable axis values that do not overlap.


b	Create bar charts in ggplot or similar. The bars should be in descending order, Use any color palette of your choice other than the default.


c	Is there a relationship between Age and Income?  Create a scatterplot and make an assessment of whether there is a relationship.  Color each point based on the Gender of the participant.  You’re welcome to use lm() or similar functions to back up your claims.


d	What about Life Satisfaction?  Create another scatterplot.  Is there a discernible relationship there to what?   



